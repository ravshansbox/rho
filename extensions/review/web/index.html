<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Review</title>
  <style>
    @font-face { font-family: 'Iosevka Web'; font-style: normal; font-display: swap; font-weight: 400; src: url(https://cdn.jsdelivr.net/fontsource/fonts/iosevka@latest/latin-400-normal.woff2) format('woff2'); }
    @font-face { font-family: 'Iosevka Web'; font-style: normal; font-display: swap; font-weight: 500; src: url(https://cdn.jsdelivr.net/fontsource/fonts/iosevka@latest/latin-500-normal.woff2) format('woff2'); }
    @font-face { font-family: 'Iosevka Web'; font-style: normal; font-display: swap; font-weight: 700; src: url(https://cdn.jsdelivr.net/fontsource/fonts/iosevka@latest/latin-700-normal.woff2) format('woff2'); }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <link rel="stylesheet" href="/css/review.css">
</head>
<body x-data="reviewApp()" @keydown.window="handleKeydown($event)">

  <!-- Nav bar -->
  <nav class="nav-bar">
    <div class="nav-left">
      <button class="nav-toggle" @click="showFilesPanel = !showFilesPanel" aria-label="Toggle file list" :aria-expanded="showFilesPanel">‚â°</button>
      <span class="nav-title">review</span>
      <span class="nav-count" x-text="`¬∑ ${files.length} file${files.length !== 1 ? 's' : ''}`"></span>
      <span class="connection-dot" :class="connected ? 'connection-dot--on' : 'connection-dot--off'" :title="connected ? 'Connected' : 'Disconnected'"></span>
    </div>
  </nav>

  <template x-if="reviewComplete">
    <div class="review-complete">
      <p x-text="reviewComplete"></p>
      <p class="text-muted">You can close this tab.</p>
    </div>
  </template>

  <div class="layout" x-show="!reviewComplete">
    <!-- Sidebar / mobile file panel -->
    <aside class="sidebar" :class="{ 'sidebar--open': showFilesPanel }">
      <!-- Mobile toggle header -->
      <button class="sidebar-toggle" @click="showFilesPanel = !showFilesPanel" :aria-expanded="showFilesPanel">
        <span x-text="showFilesPanel ? '‚ñº' : '‚ñ∂'"></span>
        <span x-text="`Files (${files.length})`"></span>
      </button>

      <ul class="file-list" x-show="showFilesPanel" x-transition>
        <template x-for="(file, index) in files" :key="file.path">
          <li class="file-item"
              :class="{ 'file-item--active': index === activeFileIndex }"
              @click="selectFile(index)">
            <span class="file-name" x-text="file.relativePath"></span>
            <span class="file-badge" x-text="fileCommentCount(file.relativePath)"></span>
          </li>
        </template>
      </ul>
    </aside>

    <!-- Code area -->
    <main class="code-area">
      <template x-if="connectionLost">
        <div class="connection-lost-banner">Connection lost ‚Äî review cancelled by server.</div>
      </template>
      <template x-if="fileWarnings.length > 0">
        <div class="warnings-list">
          <template x-for="(w, wi) in fileWarnings" :key="wi">
            <div class="warning-banner">
              <span x-text="w"></span>
              <button class="btn-icon warning-dismiss" @click="dismissWarning(wi)" title="Dismiss">‚úï</button>
            </div>
          </template>
        </div>
      </template>
      <template x-if="contextMessage">
        <div class="context-banner" x-text="contextMessage"></div>
      </template>
      <template x-if="activeFile">
        <div>
          <div class="file-header">
            <span class="file-header-name" x-text="activeFile.relativePath"></span>
            <span class="file-header-lang" x-text="activeFile.language"></span>
          </div>
          <div class="code-viewer">
            <div class="code-block"><template x-for="(line, i) in activeFile.highlightedLines" :key="i"><div class="code-line-wrapper"><div class="code-line" :class="{ 'code-line--selected': isLineSelected(i + 1), 'code-line--commented': isLineCommented(i + 1) }"><span class="line-number" @click="onLineClick(i + 1, $event)" x-text="i + 1"></span><span class="line-content" x-html="line"></span></div><template x-for="(cmt, ci) in getCommentsForLine(i + 1)" :key="ci"><div class="saved-comment">
    <div class="saved-comment-header">
      <span class="saved-comment-range" x-text="cmt.startLine === cmt.endLine ? `Line ${cmt.startLine}` : `Lines ${cmt.startLine}‚Äì${cmt.endLine}`"></span>
      <div class="saved-comment-actions">
        <button class="btn-icon" @click="editComment(activeFile.relativePath, ci)" title="Edit">‚úèÔ∏è</button>
        <button class="btn-icon" @click="deleteComment(activeFile.relativePath, ci)" title="Delete">üóëÔ∏è</button>
      </div>
    </div>
    <details class="saved-comment-quote">
      <summary>source</summary>
      <pre x-text="cmt.selectedText"></pre>
    </details>
    <p class="saved-comment-text" x-text="cmt.comment"></p>
  </div></template><template x-if="activeComment && activeComment.endLine === (i + 1) && activeComment.fileIndex === activeFileIndex"><div class="comment-form">
    <div class="comment-form-header">
      <span class="comment-range" x-text="activeComment.startLine === activeComment.endLine ? `Line ${activeComment.startLine}` : `Lines ${activeComment.startLine}‚Äì${activeComment.endLine}`"></span>
      <div class="range-controls">
        <button @click="expandRangeUp()" :disabled="activeComment.startLine <= 1">‚ñ≤</button>
        <button @click="expandRangeDown()" :disabled="activeComment.endLine >= activeFile.highlightedLines.length">‚ñº</button>
      </div>
    </div>
    <blockquote class="comment-quote" x-text="getSelectedText()"></blockquote>
    <textarea class="comment-input" x-model="activeComment.text" placeholder="Leave a comment..." rows="3" x-ref="commentInput"></textarea>
    <div class="comment-form-actions">
      <button class="btn btn--cancel" @click="cancelComment()">Cancel</button>
      <button class="btn btn--save" @click="saveComment()">Save</button>
    </div>
  </div></template></div></template></div>
          </div>
        </div>
      </template>
      <template x-if="!activeFile">
        <div class="empty-state">
          <p>No files loaded.</p>
        </div>
      </template>
    </main>
  </div>

  <!-- Bottom bar -->
  <footer class="bottom-bar" x-show="!reviewComplete">
    <span class="comment-count" x-text="`${totalComments()} comment${totalComments() !== 1 ? 's' : ''}`"></span>
    <div class="bottom-actions">
      <button class="btn btn--cancel" @click="cancelReview()">Cancel</button>
      <button class="btn btn--submit" @click="submitReview()" :disabled="totalComments() === 0 || !connected">Submit ‚ñ∂</button>
    </div>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/rust.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="/js/review.js"></script>
</body>
</html>
