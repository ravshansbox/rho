<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reviews</title>
  <style>
    :root {
      --bg: #0c0c0c;
      --bg-alt: #111111;
      --bg-card: #151515;
      --border: #1a1a1a;
      --border-bright: #2a2a2a;
      --text: #c8c8c8;
      --text-muted: #666666;
      --text-dim: #444444;
      --green: #22c55e;
      --cyan: #5eead4;
      --yellow: #fbbf24;
      --red: #ef4444;
      --mono: 'JetBrains Mono', 'Cascadia Code', 'Fira Code', monospace;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--mono);
      font-size: 14px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      max-width: 720px;
      margin: 0 auto;
      padding: 48px 24px;
    }

    h1 {
      font-size: 16px;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 32px;
    }

    h1 span { color: var(--text); }

    .empty {
      color: var(--text-dim);
      padding: 48px 0;
      text-align: center;
    }

    .session-list {
      display: flex;
      flex-direction: column;
      gap: 1px;
      background: var(--border);
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
    }

    .session-row {
      display: flex;
      align-items: center;
      background: var(--bg-card);
      transition: background 0.1s;
    }

    .session-row:hover { background: var(--bg-alt); }
    .session-row.session--done { opacity: 0.5; }
    .session-row.session--done:hover { opacity: 0.7; }

    .session {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 14px 16px;
      flex: 1;
      min-width: 0;
      text-decoration: none;
      color: inherit;
    }

    .session-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .status--active { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .status--submitted { background: var(--cyan); }
    .status--cancelled { background: var(--text-dim); }

    .session-info { flex: 1; min-width: 0; }

    .session-files {
      font-size: 13px;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .session-meta {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .session-message {
      font-size: 12px;
      color: var(--text-dim);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .session-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      flex-shrink: 0;
    }

    .badge--active { background: rgba(34, 197, 94, 0.15); color: var(--green); }
    .badge--submitted { background: rgba(94, 234, 212, 0.1); color: var(--cyan); }
    .badge--cancelled { background: rgba(255, 255, 255, 0.05); color: var(--text-dim); }

    .refresh-hint {
      text-align: center;
      padding: 16px;
      font-size: 12px;
      color: var(--text-dim);
    }

    h1 a {
      color: inherit;
      text-decoration: none;
    }

    h1 a:hover {
      color: var(--text);
    }

    h1 .home-link {
      color: var(--green);
      text-decoration: none;
    }

    h1 .home-link:hover {
      text-decoration: underline;
    }

    .session-cancel {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      margin-right: 12px;
      padding: 0;
      background: none;
      border: 1px solid transparent;
      border-radius: 4px;
      color: var(--text-dim);
      font-size: 14px;
      cursor: pointer;
      flex-shrink: 0;
      transition: background 0.1s, color 0.1s, border-color 0.1s;
    }

    .session-cancel:hover {
      background: rgba(239, 68, 68, 0.1);
      color: var(--red);
      border-color: rgba(239, 68, 68, 0.3);
    }
  </style>
</head>
<body>
  <div class="container" id="app">
    <h1><a href="/" class="home-link">rho</a> · <span>review</span> · sessions</h1>
    <div id="content"><div class="empty">loading...</div></div>
    <div class="refresh-hint">auto-refreshes every 5s</div>
  </div>

  <script>
    function relativeTime(ts) {
      const diff = Date.now() - ts;
      if (diff < 60000) return 'just now';
      if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
      if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
      return Math.floor(diff / 86400000) + 'd ago';
    }

    function statusClass(s) {
      if (!s.done) return 'active';
      return s.cancelled ? 'cancelled' : 'submitted';
    }

    function statusLabel(s) {
      if (!s.done) return 'active';
      return s.cancelled ? 'cancelled' : 'submitted';
    }

    function renderSessions(sessions) {
      const el = document.getElementById('content');

      if (!sessions.length) {
        el.innerHTML = '<div class="empty">no active review sessions</div>';
        return;
      }

      const html = '<div class="session-list">' + sessions.map(s => {
        const status = statusClass(s);
        const label = statusLabel(s);
        const fileList = s.files.join(', ');
        const url = '/review/' + s.id + '?token=' + encodeURIComponent(s.token);
        const doneClass = s.done ? ' session--done' : '';

        const cancelBtn = !s.done
          ? '<button class="session-cancel" data-id="' + escapeHtml(s.id) + '" data-token="' + escapeHtml(s.token) + '" title="Cancel review">✕</button>'
          : '';

        return '<div class="session-row' + doneClass + '">'
          + '<a class="session" href="' + url + '">'
          + '<div class="session-status status--' + status + '"></div>'
          + '<div class="session-info">'
          + '<div class="session-files">' + escapeHtml(fileList) + '</div>'
          + '<div class="session-meta">'
          + '<span>' + s.fileCount + ' file' + (s.fileCount !== 1 ? 's' : '') + '</span>'
          + '<span>' + relativeTime(s.createdAt) + '</span>'
          + (s.done && !s.cancelled ? '<span>' + s.commentCount + ' comment' + (s.commentCount !== 1 ? 's' : '') + '</span>' : '')
          + '</div>'
          + (s.message ? '<div class="session-message">' + escapeHtml(s.message) + '</div>' : '')
          + '</div>'
          + '<span class="session-badge badge--' + status + '">' + label + '</span>'
          + '</a>'
          + cancelBtn
          + '</div>';
      }).join('') + '</div>';

      el.innerHTML = html;
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    async function refresh() {
      try {
        const res = await fetch('/api/review/sessions');
        if (res.ok) renderSessions(await res.json());
      } catch {}
    }

    document.getElementById('content').addEventListener('click', async function(e) {
      const btn = e.target.closest('.session-cancel');
      if (!btn) return;
      e.preventDefault();
      e.stopPropagation();
      const id = btn.dataset.id;
      const token = btn.dataset.token;
      if (!id || !token) return;
      try {
        const res = await fetch('/api/review/sessions/' + encodeURIComponent(id) + '?token=' + encodeURIComponent(token), {
          method: 'DELETE'
        });
        if (res.ok) refresh();
      } catch {}
    });

    refresh();
    setInterval(refresh, 5000);
  </script>
</body>
</html>
