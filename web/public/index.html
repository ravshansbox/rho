<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#161b22" />
    <meta name="description" content="Persistent coding agent and technical copilot" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="rho" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" href="/favicon.svg" />
    <title>Rho Web UI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://unpkg.com" />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Iosevka ‚Äî narrow monospace for mobile density */
      @font-face { font-family: 'Iosevka Web'; font-style: normal; font-display: swap; font-weight: 400; src: url(https://cdn.jsdelivr.net/fontsource/fonts/iosevka@latest/latin-400-normal.woff2) format('woff2'); }
      @font-face { font-family: 'Iosevka Web'; font-style: normal; font-display: swap; font-weight: 500; src: url(https://cdn.jsdelivr.net/fontsource/fonts/iosevka@latest/latin-500-normal.woff2) format('woff2'); }
      @font-face { font-family: 'Iosevka Web'; font-style: normal; font-display: swap; font-weight: 700; src: url(https://cdn.jsdelivr.net/fontsource/fonts/iosevka@latest/latin-700-normal.woff2) format('woff2'); }
    </style>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css"
    />
    <link rel="stylesheet" href="/css/style.css?v=20260218v43" />
    <link rel="stylesheet" href="/css/review-panel.css?v=20260219v1" />
    <!-- Preload CDN scripts for faster initial render -->
    <link rel="preload" href="https://unpkg.com/htmx.org@1.9.12" as="script" />
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/marked/marked.min.js" as="script" />
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js" as="script" />
    <link rel="preload" href="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js" as="script" />
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>
    <script src="/js/app.js?v=20260211v" defer></script>
    <script src="/js/slash-contract.js?v=20260214v" defer></script>
    <script src="/js/chat.js?v=20260218v20" defer></script>
    <script src="/js/config.js?v=20260211v" defer></script>
    <script src="/js/memory.js?v=20260211v" defer></script>
    <script src="/js/review-panel.js?v=20260219v1" defer></script>
    <script src="/js/pull-to-refresh.js?v=20260218v" defer></script>

    <script src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js" defer></script>
  </head>
  <body>
    <div class="app" x-data="rhoApp()">
      <nav class="nav">
        <div class="nav-inner">
          <div class="nav-seg nav-logo">rho</div>
          <div class="nav-seg nav-title">web ui</div>
          <div class="nav-tabs" role="tablist" aria-label="Rho views">
            <button
              class="nav-tab"
              :class="{ active: view === 'chat' }"
              @click="setView('chat')"
              type="button"
              role="tab"
              :aria-selected="view === 'chat'"
            >
              Chat
            </button>
            <button
              class="nav-tab"
              :class="{ active: view === 'memory' }"
              @click="setView('memory')"
              type="button"
              role="tab"
              :aria-selected="view === 'memory'"
            >
              Brain
            </button>
            <button
              class="nav-tab"
              :class="{ active: view === 'review' }"
              @click="setView('review')"
              type="button"
              role="tab"
              :aria-selected="view === 'review'"
            >
              Review
              <span
                class="nav-tab-badge"
                x-show="activeReviewCount > 0"
                x-text="activeReviewCount"
              ></span>
            </button>
            <button
              class="nav-tab nav-tab-icon theme-toggle"
              @click="toggleTheme()"
              type="button"
              title="Toggle theme"
            >
              <span x-text="theme === 'light' ? '&#x2600;' : '&#x263E;'"></span>
            </button>
            <button
              class="nav-tab nav-tab-icon"
              :class="{ active: view === 'config' }"
              @click="setView('config')"
              type="button"
              role="tab"
              :aria-selected="view === 'config'"
            >
              <span>&#x2699;</span>
            </button>
          </div>
        </div>
      </nav>

      <main class="main">
        <section class="view chat-view" x-show="view === 'chat'" x-cloak role="tabpanel">
          <div class="view-body" x-data="rhoChat()" x-init="init()">
            <div class="chat-layout">
              <!-- Sessions backdrop (click to close) -->
              <div
                class="chat-sessions-backdrop"
                :class="{ visible: showSessionsPanel }"
                @click="showSessionsPanel = false"
              ></div>
              <aside class="chat-sessions" :class="{ open: showSessionsPanel }" @keydown.escape.window="showSessionsPanel = false">
                <div class="chat-section-header">
                  <div class="chat-section-title">Sessions <span x-show="sessionsTotal > 0" x-text="'(' + sessionsTotal + ')'"></span></div>
                </div>
                <div class="chat-section-meta chat-loading-inline" x-show="isLoadingSessions">
                  <span class="loading-spinner-sm"></span>
                  <span>Loading...</span>
                </div>
                <div class="chat-section-meta chat-error" x-show="error" x-text="error"></div>
                <div class="chat-list" @scroll="onSessionsScroll($event)">
                  <template x-for="session in sessions" :key="session.id">
                    <button
                      class="chat-session"
                      :class="{ active: session.id === activeSessionId }"
                      type="button"
                      @click="selectSession(session.id)"
                    >
                      <div class="chat-session-title" x-text="session.name || session.firstPrompt || (session.messageCount > 0 ? session.id.substring(0, 8) : 'New session')"></div>
                      <div class="chat-session-id" x-show="session.firstPrompt || session.name" x-text="session.id.substring(0, 8)"></div>
                      <div class="chat-session-meta">
                        <span x-text="formatTimestampShort(session.timestamp)"></span>
                        <span x-text="messageCountLabel(session)"></span>
                        <span
                          class="chat-session-badge fork"
                          x-show="sessionForkBadge(session)"
                          x-text="sessionForkBadge(session)"
                          :title="sessionForkTitle(session)"
                        ></span>
                      </div>
                    </button>
                  </template>
                  <div class="chat-loading-more" x-show="isLoadingMore">
                    <span class="loading-spinner-sm"></span> Loading...
                  </div>
                  <div class="chat-session-count" x-show="sessions.length > 0 && !allSessionsLoaded" x-text="`${sessions.length} of ${sessionsTotal}`"></div>
                  <div class="chat-empty-state" x-show="!isLoadingSessions && sessions.length === 0">
                    <span class="empty-icon">&#x1F4C1;</span>
                    <span>No sessions yet</span>
                    <span class="empty-hint">Sessions appear here when you start using Rho CLI</span>
                  </div>
                </div>
              </aside>

              <section class="chat-thread"
                @dragover.prevent="handleDragOver($event)"
                @dragleave="handleDragLeave($event)"
                @drop.prevent="handleDrop($event)"
              >
                <!-- Drop zone overlay -->
                <div class="chat-drop-overlay" x-show="isDraggingOver" x-cloak x-transition.opacity>
                  <div class="chat-drop-label">üìé Drop image to attach</div>
                </div>

                <div class="chat-thread-header">
                  <button
                    class="chat-sessions-toggle"
                    :class="{ open: showSessionsPanel }"
                    type="button"
                    @click="showSessionsPanel = !showSessionsPanel"
                    title="Toggle sessions"
                  >
                    <span class="toggle-icon" x-text="showSessionsPanel ? '‚úï' : '‚ò∞'"></span>
                  </button>
                  <div class="chat-thread-info">
                    <div class="chat-thread-title" x-text="activeSession ? sessionLabel(activeSession) : 'Select a session'"></div>
                    <div class="chat-thread-meta" x-show="activeSession" x-text="messageCountLabel(activeSession)"></div>
                  </div>
                  <div class="chat-thread-status">
                    <span class="chat-live-badge" x-show="isForkActive()">‚óè LIVE</span>
                    <span class="chat-readonly-badge" x-show="!isForkActive() && activeSession">READ-ONLY</span>
                  </div>
                  <div class="chat-thread-actions">
                    <button
                      class="btn btn-sm btn-yellow"
                      type="button"
                      @click="forkFromLatest()"
                      :disabled="!activeSession || !hasForkPoints() || isForking"
                    >
                      <span x-show="!isForking">Fork</span>
                      <span x-show="isForking">Forking...</span>
                    </button>
                    <button
                      class="btn btn-sm btn-green"
                      type="button"
                      @click="newSession()"
                      :disabled="isForking"
                    >+ New</button>
                  </div>
                </div>

                <!-- Reconnection Banner -->
                <div class="reconnect-banner" x-show="showReconnectBanner" x-cloak>
                  <span class="reconnect-icon">&#x26A0;</span>
                  <span>Connection lost. Reconnecting...</span>
                  <button class="btn btn-ghost btn-sm" type="button" @click="manualReconnect()">
                    Retry now
                  </button>
                </div>

                <div class="chat-thread-body" x-ref="thread" @scroll="handleThreadScroll()">
                  <div class="chat-loading" x-show="isLoadingSession">
                    <span class="loading-spinner"></span>
                    <span>Loading session...</span>
                  </div>
                  <div class="chat-empty" x-show="!isLoadingSession && activeSession && !hasMessages()">
                    <span class="empty-icon">&#x1F4AC;</span>
                    <span x-text="isForkActive() ? 'Type a message below to start chatting.' : 'No messages yet. Fork this session to start chatting.'"></span>
                  </div>
                  <div class="chat-empty" x-show="!activeSession && !isLoadingSession">
                    <span class="empty-icon">&#x1F4C2;</span>
                    <span>Select a session from the sidebar to view messages.</span>
                  </div>

                  <!-- Load earlier messages button -->
                  <button
                    x-show="hasEarlierMessages"
                    @click="loadEarlierMessages()"
                    class="load-earlier-btn"
                    type="button"
                  >
                    Load earlier messages
                  </button>

                  <!-- Streaming indicator (dots removed ‚Äî composer border pulses instead) -->

                  <template x-for="message in renderedMessages" :key="message.id">
                    <article class="chat-message" :class="message.role" :data-message-id="message.id">
                      <div class="chat-message-meta">
                        <div class="chat-message-meta-left">
                          <span class="chat-message-role" x-text="message.roleLabel"></span>
                          <span class="chat-message-time" x-text="message.timestamp"></span>
                        </div>
                        <div class="chat-message-meta-right">
                          <button
                            class="chat-fork-button"
                            type="button"
                            x-show="message.role === 'user' && canForkMessage(message)"
                            @click="forkFromEntry(message.id)"
                            :title="messageForkPreview(message)"
                          >
                            Fork from here
                          </button>
                        </div>
                      </div>
                      <div class="chat-message-body">
                        <template x-for="part in message.parts" :key="part.key">
                          <div>
                            <template x-if="part.type === 'text' && part.render === 'html'">
                              <div class="chat-text" x-html="part.content"></div>
                            </template>
                            <template x-if="part.type === 'text' && part.render === 'text'">
                              <div class="chat-text" x-text="part.content"></div>
                            </template>
                            <template x-if="part.type === 'image'">
                              <div class="chat-image">
                                <img :src="part.dataUrl" alt="attached image" />
                              </div>
                            </template>
                            <template x-if="part.type === 'thinking'">
                              <div class="chat-block thinking" x-data="{ open: false }">
                                <button class="chat-block-toggle" type="button" @click="open = !open">
                                  <span class="thinking-icon">üí≠</span>
                                  Thinking
                                  <span class="tool-chevron" x-text="open ? '‚ñæ' : '‚ñ∏'"></span>
                                </button>
                                <div class="thinking-preview" x-show="!open" x-text="part.preview"></div>
                                <div class="chat-block-body" x-show="open" x-html="part.content"></div>
                              </div>
                            </template>
                            <template x-if="part.type === 'tool_call'">
                              <div class="chat-block tool" x-data="{ open: false, showRaw: false, showAllOutput: false, showAllDiff: false }">
                                <!-- ‚îÄ‚îÄ‚îÄ Collapsed header ‚îÄ‚îÄ‚îÄ -->
                                <button class="chat-block-toggle" type="button" @click="open = !open">
                                  <span class="tool-status-icon" :class="part.status" x-text="part.status === 'running' ? '‚ü≥' : part.status === 'error' ? '‚úó' : '‚úì'"></span>
                                  <span class="tool-name" x-text="part.name"></span>
                                  <!-- Semantic header: path badge for file tools (full path desktop, filename mobile) -->
                                  <template x-if="part.semantic && (part.semantic.tool === 'edit' || part.semantic.tool === 'write' || part.semantic.tool === 'read')">
                                    <span class="tool-path-badge-wrap">
                                      <span class="tool-path-badge tool-path-full" :title="part.semantic.path" x-text="part.argsSummary"></span>
                                      <span class="tool-path-badge tool-path-short" :title="part.semantic.path" x-text="part.semantic.filename || part.semantic.path"></span>
                                    </span>
                                  </template>
                                  <!-- Semantic header: command for bash -->
                                  <template x-if="part.semantic && part.semantic.tool === 'bash'">
                                    <span class="tool-command-hint" x-text="part.argsSummary"></span>
                                  </template>
                                  <!-- Semantic header: action for brain/vault/email -->
                                  <template x-if="part.semantic && (part.semantic.tool === 'brain' || part.semantic.tool === 'vault' || part.semantic.tool === 'email')">
                                    <span class="tool-action-hint" x-text="part.argsSummary"></span>
                                  </template>
                                  <!-- Fallback: generic args hint for unknown tools -->
                                  <template x-if="!part.semantic">
                                    <span class="tool-args-hint" x-text="part.argsSummary"></span>
                                  </template>
                                  <span class="tool-duration" x-show="part.duration" x-text="part.duration"></span>
                                  <span class="tool-chevron" x-text="open ? '‚ñæ' : '‚ñ∏'"></span>
                                </button>
                                <!-- Collapsed preview -->
                                <div class="tool-preview" x-show="!open && part.outputPreview && !(part.semantic?.tool === 'edit' && part.semantic?.hasOldNew)" x-text="part.outputPreview"></div>
                                <div class="tool-preview tool-preview-diff" x-show="!open && part.semantic?.tool === 'edit' && part.semantic?.hasOldNew && part.semantic?.success">
                                  <span class="diff-pill diff-pill-add" x-text="'+' + (part.semantic?.linesAdded || 0)"></span>
                                  <span class="diff-pill diff-pill-remove" x-text="'‚àí' + (part.semantic?.linesRemoved || 0)"></span>
                                </div>

                                <!-- ‚îÄ‚îÄ‚îÄ Expanded body ‚îÄ‚îÄ‚îÄ -->
                                <div class="chat-block-body" x-show="open">
                                  <!-- Raw toggle button -->
                                  <button class="sem-raw-toggle" type="button" @click="showRaw = !showRaw" x-show="part.semantic" x-text="showRaw ? '‚Üê semantic' : 'raw ‚Üó'"></button>

                                  <!-- ‚ïê‚ïê‚ïê SEMANTIC: Edit tool ‚ïê‚ïê‚ïê -->
                                  <template x-if="part.semantic && part.semantic.tool === 'edit' && !showRaw">
                                    <div class="sem-edit">
                                      <div class="sem-file-header">
                                        <span class="sem-file-icon">üìÑ</span>
                                        <span class="sem-file-path" :title="part.semantic.path" x-text="part.semantic.path"></span>
                                        <span class="sem-diff-stats" x-show="part.semantic.success && part.semantic.hasOldNew">
                                          <span class="diff-pill diff-pill-add" x-text="'+' + (part.semantic.linesAdded || 0)"></span>
                                          <span class="diff-pill diff-pill-remove" x-text="'‚àí' + (part.semantic.linesRemoved || 0)"></span>
                                        </span>
                                        <span class="sem-badge sem-badge-success" x-show="part.semantic.success && !part.semantic.hasOldNew">‚úì Applied</span>
                                        <span class="sem-badge sem-badge-error" x-show="!part.semantic.success">‚úó Failed</span>
                                      </div>
                                      <template x-if="part.semantic.hasOldNew">
                                        <div class="sem-diff">
                                          <div class="sem-diff-section sem-diff-remove">
                                            <div class="sem-diff-label">‚àí removed</div>
                                            <pre class="sem-diff-code"><code x-text="part.semantic.oldText"></code></pre>
                                          </div>
                                          <div class="sem-diff-section sem-diff-add">
                                            <div class="sem-diff-label">+ added</div>
                                            <pre class="sem-diff-code"><code x-text="part.semantic.newText"></code></pre>
                                          </div>
                                        </div>
                                      </template>
                                    </div>
                                  </template>

                                  <!-- ‚ïê‚ïê‚ïê SEMANTIC: Write tool ‚ïê‚ïê‚ïê -->
                                  <template x-if="part.semantic && part.semantic.tool === 'write' && !showRaw">
                                    <div class="sem-write">
                                      <div class="sem-file-header">
                                        <span class="sem-file-icon">üìù</span>
                                        <span class="sem-file-path" :title="part.semantic.path" x-text="part.semantic.path"></span>
                                        <span class="sem-badge sem-badge-success" x-show="part.semantic.success">‚úì Written</span>
                                      </div>
                                      <pre class="sem-file-content"><code x-text="part.semantic.content.length > 3000 ? part.semantic.content.slice(0, 3000) + '\n... (truncated)' : part.semantic.content"></code></pre>
                                    </div>
                                  </template>

                                  <!-- ‚ïê‚ïê‚ïê SEMANTIC: Read tool ‚ïê‚ïê‚ïê -->
                                  <template x-if="part.semantic && part.semantic.tool === 'read' && !showRaw">
                                    <div class="sem-read">
                                      <div class="sem-file-header">
                                        <span class="sem-file-icon">üìñ</span>
                                        <span class="sem-file-path" :title="part.semantic.path" x-text="part.semantic.path"></span>
                                        <span class="sem-file-range" x-show="part.semantic.offset" x-text="'lines ' + part.semantic.offset + (part.semantic.limit ? '-' + (part.semantic.offset + part.semantic.limit - 1) : '+')"></span>
                                        <span class="sem-file-lines" x-text="part.semantic.lineCount + ' lines'"></span>
                                      </div>
                                      <pre class="sem-file-content sem-highlighted" x-data="{ expanded: false }">
                                        <template x-if="part.semantic.lineCount <= 100 || expanded">
                                          <code x-text="part.output"></code>
                                        </template>
                                        <template x-if="part.semantic.lineCount > 100 && !expanded">
                                          <code x-text="part.output.split('\n').slice(0, 60).join('\n')"></code>
                                        </template>
                                        <template x-if="part.semantic.lineCount > 100 && !expanded">
                                          <button class="sem-show-all" type="button" @click="expanded = true" x-text="'Show all ' + part.semantic.lineCount + ' lines'"></button>
                                        </template>
                                      </pre>
                                    </div>
                                  </template>

                                  <!-- ‚ïê‚ïê‚ïê SEMANTIC: Bash tool ‚ïê‚ïê‚ïê -->
                                  <template x-if="part.semantic && part.semantic.tool === 'bash' && !showRaw">
                                    <div class="sem-bash" :class="part.semantic.isError ? 'sem-bash-error' : ''">
                                      <div class="sem-bash-cmd">
                                        <span class="sem-bash-prompt">$</span>
                                        <code x-text="part.semantic.command"></code>
                                      </div>
                                      <template x-if="part.output">
                                        <div class="sem-bash-output" x-data="{ expanded: false }">
                                          <!-- Short output: show all -->
                                          <template x-if="part.semantic.lineCount <= 25">
                                            <pre><code x-text="part.output"></code></pre>
                                          </template>
                                          <!-- Long output: truncated with expander -->
                                          <template x-if="part.semantic.lineCount > 25 && !expanded">
                                            <div>
                                              <pre><code x-text="part.output.split('\n').slice(0, 15).join('\n')"></code></pre>
                                              <button class="sem-show-hidden" type="button" @click="expanded = true" x-text="'‚ãØ show ' + (part.semantic.lineCount - 25) + ' hidden lines'"></button>
                                              <pre><code x-text="part.output.split('\n').slice(-10).join('\n')"></code></pre>
                                            </div>
                                          </template>
                                          <!-- Expanded: show all -->
                                          <template x-if="part.semantic.lineCount > 25 && expanded">
                                            <pre><code x-text="part.output"></code></pre>
                                          </template>
                                        </div>
                                      </template>
                                    </div>
                                  </template>

                                  <!-- ‚ïê‚ïê‚ïê SEMANTIC: Brain tool ‚ïê‚ïê‚ïê -->
                                  <template x-if="part.semantic && part.semantic.tool === 'brain' && !showRaw">
                                    <div class="sem-brain">
                                      <div class="sem-action-header">
                                        <span class="sem-action-badge">üß†</span>
                                        <span class="sem-action-label" x-text="part.semantic.summary"></span>
                                        <span class="sem-action-id" x-show="part.semantic.id" x-text="part.semantic.id"></span>
                                      </div>
                                      <pre class="sem-structured-output"><code x-text="part.output"></code></pre>
                                    </div>
                                  </template>

                                  <!-- ‚ïê‚ïê‚ïê SEMANTIC: Vault tool ‚ïê‚ïê‚ïê -->
                                  <template x-if="part.semantic && part.semantic.tool === 'vault' && !showRaw">
                                    <div class="sem-vault">
                                      <div class="sem-action-header">
                                        <span class="sem-action-badge">üìö</span>
                                        <span class="sem-action-label" x-text="part.semantic.summary"></span>
                                        <span class="sem-action-slug" x-show="part.semantic.slug" x-text="part.semantic.slug"></span>
                                      </div>
                                      <pre class="sem-structured-output"><code x-text="part.output"></code></pre>
                                    </div>
                                  </template>

                                  <!-- ‚ïê‚ïê‚ïê SEMANTIC: Email tool ‚ïê‚ïê‚ïê -->
                                  <template x-if="part.semantic && part.semantic.tool === 'email' && !showRaw">
                                    <div class="sem-email">
                                      <div class="sem-action-header">
                                        <span class="sem-action-badge">‚úâÔ∏è</span>
                                        <span class="sem-action-label" x-text="part.semantic.summary"></span>
                                      </div>
                                      <template x-if="part.semantic.subject">
                                        <div class="sem-email-subject" x-text="'Subject: ' + part.semantic.subject"></div>
                                      </template>
                                      <pre class="sem-structured-output"><code x-text="part.output"></code></pre>
                                    </div>
                                  </template>

                                  <!-- ‚ïê‚ïê‚ïê RAW view (fallback or toggled) ‚ïê‚ïê‚ïê -->
                                  <template x-if="!part.semantic || showRaw">
                                    <div class="sem-raw">
                                      <div class="chat-block-label">args</div>
                                      <pre><code x-text="part.args"></code></pre>
                                      <div class="chat-block-label" x-show="part.output">output</div>
                                      <pre x-show="part.output"><code x-text="part.output"></code></pre>
                                    </div>
                                  </template>
                                </div>
                              </div>
                            </template>
                            <template x-if="part.type === 'bash'">
                              <div class="chat-block bash">
                                <div class="chat-block-label">bash</div>
                                <pre class="bash-command"><code x-text="part.command"></code></pre>
                                <pre class="bash-output" x-show="part.output"><code x-text="part.output"></code></pre>
                              </div>
                            </template>
                            <template x-if="part.type === 'compaction'">
                              <div class="chat-banner compaction">
                                Context compacted ¬∑ <span x-text="part.summary"></span>
                              </div>
                            </template>
                            <template x-if="part.type === 'summary'">
                              <div class="chat-banner summary">
                                Summary ¬∑ <span x-text="part.summary"></span>
                              </div>
                            </template>
                            <template x-if="part.type === 'retry'">
                              <div class="chat-banner retry">
                                Retry ¬∑ <span x-text="part.summary"></span>
                              </div>
                            </template>
                            <template x-if="part.type === 'error'">
                              <div class="chat-banner error" x-text="part.text"></div>
                            </template>
                          </div>
                        </template>
                      </div>
                      <div class="chat-usage chat-usage-desktop" x-show="message.usageData?.desktop" x-text="message.usageData?.desktop"></div>
                      <div class="chat-usage chat-usage-mobile" x-show="message.usageData?.mobile" x-text="message.usageData?.mobile"></div>
                    </article>
                  </template>
                </div>

                <!-- Scroll to bottom button -->
                <button
                  class="chat-scroll-bottom"
                  type="button"
                  x-show="userScrolledUp"
                  x-cloak
                  x-transition.opacity
                  @click="userScrolledUp = false; scrollThreadToBottom()"
                  title="Scroll to bottom"
                >
                  ‚Üì New messages
                </button>

                <div class="chat-controls" x-show="isForkActive()">
                  <div class="chat-controls-left">
                    <div class="chat-control-group">
                      <label class="chat-control-label">Model</label>
                      <select
                        class="chat-control-select"
                        @change="setModel(availableModels.find(m => modelDropdownLabel(m) === $event.target.value))"
                        :disabled="!canSwitchModel()"
                      >
                        <template x-for="model in availableModels" :key="modelDropdownLabel(model)">
                          <option
                            :value="modelDropdownLabel(model)"
                            :selected="isCurrentModel(model)"
                            x-text="modelDropdownLabel(model)"
                          ></option>
                        </template>
                      </select>
                    </div>
                    <div class="chat-control-group">
                      <label class="chat-control-label">Thinking</label>
                      <select
                        class="chat-control-select"
                        @change="setThinkingLevel($event.target.value)"
                        :disabled="!canChangeThinking()"
                      >
                        <template x-for="level in thinkingLevels" :key="level">
                          <option
                            :value="level"
                            :selected="level === currentThinkingLevel"
                            x-text="level"
                          ></option>
                        </template>
                      </select>
                    </div>
                  </div>
                  <div class="chat-controls-right">
                    <button
                      class="btn btn-danger chat-control-btn"
                      type="button"
                      @click="abort()"
                      :disabled="!canAbort()"
                      x-show="isStreaming"
                    >
                      Abort
                    </button>
                  </div>
                </div>

                <!-- Extension widget (above input) -->
                <div class="chat-widget" x-show="hasWidget()" x-cloak>
                  <div class="chat-widget-content" x-html="widgetContent()"></div>
                  <button class="chat-widget-close" type="button" @click="extensionWidget = null">&times;</button>
                </div>

                <form class="chat-composer" :class="{ streaming: isStreaming }" @submit.prevent="handlePromptSubmit()" x-show="isForkActive()">
                  <!-- Image attachments preview -->
                  <div class="chat-composer-attachments" x-show="pendingImages.length > 0">
                    <template x-for="(img, idx) in pendingImages" :key="idx">
                      <div class="chat-attachment-thumb">
                        <img :src="img.dataUrl" alt="attachment" />
                        <button class="chat-attachment-remove" type="button" @click="removeImage(idx)">&times;</button>
                      </div>
                    </template>
                  </div>
                  <div class="slash-ac">
                    <!-- Slash command autocomplete dropdown -->
                    <div class="slash-ac-dropdown"
                         x-ref="slashAcDropdown"
                         x-show="slashAcVisible"
                         x-cloak
                         @mousedown.prevent>
                      <template x-for="(item, idx) in slashAcItems" :key="item.name">
                        <div class="slash-ac-item"
                             :class="{ active: idx === slashAcIndex }"
                             @click="selectSlashCommand(item)"
                             @mouseenter="slashAcIndex = idx">
                          <span class="slash-ac-name" x-text="'/' + item.name"></span>
                          <span class="slash-ac-badge" x-text="item.source"></span>
                          <span class="slash-ac-desc" x-text="item.description"></span>
                        </div>
                      </template>
                      <div class="slash-ac-empty" x-show="slashAcItems.length === 0">No matching commands</div>
                    </div>
                  </div>
                  <!-- Queue bar: shows messages queued during streaming -->
                  <div class="chat-queue-bar" x-show="promptQueue.length > 0" x-cloak>
                    <button class="chat-queue-header" type="button" @click="showQueue = !showQueue">
                      <span class="chat-queue-count" x-text="promptQueue.length + ' queued'"></span>
                      <span class="chat-queue-chevron" x-text="showQueue ? '‚ñæ' : '‚ñ∏'"></span>
                    </button>
                    <div class="chat-queue-items" x-show="showQueue">
                      <template x-for="(qItem, qIdx) in promptQueue" :key="qItem.id">
                        <div class="chat-queue-item">
                          <div class="chat-queue-item-header">
                            <span class="chat-queue-item-num" x-text="'#' + (qIdx + 1)"></span>
                            <div class="chat-queue-item-actions">
                              <button class="btn btn-ghost btn-xs" type="button" x-show="qIdx < promptQueue.length - 1" @click="mergeQueueItemDown(qIdx)" title="Merge with next">‚§µ</button>
                              <label class="btn btn-ghost btn-xs chat-queue-attach" title="Attach image">
                                üìé
                                <input type="file" accept="image/*" multiple style="display:none" @change="addQueueItemImage(qItem.id, $event)" />
                              </label>
                              <button class="btn btn-ghost btn-xs chat-queue-remove" type="button" @click="removeQueueItem(qItem.id)" title="Remove">‚úï</button>
                            </div>
                          </div>
                          <textarea
                            class="chat-queue-item-text"
                            :value="qItem.text"
                            @input="updateQueueItemText(qItem.id, $event.target.value)"
                            rows="1"
                          ></textarea>
                          <div class="chat-queue-item-images" x-show="qItem.images.length > 0">
                            <template x-for="(img, imgIdx) in qItem.images" :key="imgIdx">
                              <div class="chat-attachment-thumb">
                                <img :src="img.dataUrl" alt="attachment" />
                                <button class="chat-attachment-remove" type="button" @click="removeQueueItemImage(qItem.id, imgIdx)">&times;</button>
                              </div>
                            </template>
                          </div>
                        </div>
                      </template>
                    </div>
                  </div>

                  <div class="chat-composer-row">
                    <textarea
                      class="chat-composer-input"
                      x-ref="composerInput"
                      x-model="promptText"
                      :placeholder="inputPlaceholder()"
                      rows="2"
                      :disabled="isSendingPrompt || isForking"
                      @keydown="handleComposerKeydown($event)"
                      @input="handleComposerInput($event)"
                      @paste="handleComposerPaste($event)"
                    ></textarea>
                    <div class="chat-composer-actions">
                      <input
                        type="file"
                        accept="image/*"
                        multiple
                        x-ref="imageInput"
                        style="display: none"
                        @change="handleImageSelect($event)"
                      />
                      <button
                        class="btn btn-ghost chat-attach-btn"
                        type="button"
                        @click="$refs.imageInput.click()"
                        :disabled="isSendingPrompt || isForking"
                        title="Attach image"
                      >
                        üìé
                      </button>
                      <button class="btn" type="submit" :disabled="(!promptText.trim() && pendingImages.length === 0) || isSendingPrompt || isForking">
                        <span x-text="submitButtonLabel()"></span>
                      </button>
                    </div>
                  </div>
                  <div class="chat-composer-hints" x-show="isForkActive()">
                    Enter to send ¬∑ Shift+Enter for newline ¬∑ Paste, drag, or üìé to attach images
                  </div>
                </form>

                <!-- Extension UI Dialog Overlay -->
                <div class="ext-dialog-overlay" x-show="extensionDialog" x-cloak @click.self="dismissDialog(null)">
                  <!-- Select Dialog -->
                  <template x-if="extensionDialog?.type === 'select'">
                    <div class="ext-dialog">
                      <div class="ext-dialog-header">
                        <div class="ext-dialog-title" x-text="extensionDialog.title"></div>
                        <button class="ext-dialog-close" type="button" @click="dismissDialog(null)">&times;</button>
                      </div>
                      <div class="ext-dialog-description" x-show="extensionDialog.description" x-text="extensionDialog.description"></div>
                      <div class="ext-dialog-options">
                        <template x-for="option in extensionDialog.options" :key="option.value">
                          <button class="ext-dialog-option" type="button" @click="selectDialogOption(option)">
                            <span class="ext-dialog-option-label" x-text="option.label"></span>
                            <span class="ext-dialog-option-desc" x-show="option.description" x-text="option.description"></span>
                          </button>
                        </template>
                      </div>
                    </div>
                  </template>

                  <!-- Confirm Dialog -->
                  <template x-if="extensionDialog?.type === 'confirm'">
                    <div class="ext-dialog">
                      <div class="ext-dialog-header">
                        <div class="ext-dialog-title" x-text="extensionDialog.title"></div>
                        <button class="ext-dialog-close" type="button" @click="dismissDialog(false)">&times;</button>
                      </div>
                      <div class="ext-dialog-description" x-show="extensionDialog.description" x-text="extensionDialog.description"></div>
                      <div class="ext-dialog-actions">
                        <button class="btn btn-ghost" type="button" @click="confirmDialogNo()" x-text="extensionDialog.cancelLabel"></button>
                        <button class="btn" type="button" @click="confirmDialogYes()" x-text="extensionDialog.confirmLabel"></button>
                      </div>
                    </div>
                  </template>

                  <!-- Input Dialog -->
                  <template x-if="extensionDialog?.type === 'input'">
                    <div class="ext-dialog">
                      <div class="ext-dialog-header">
                        <div class="ext-dialog-title" x-text="extensionDialog.title"></div>
                        <button class="ext-dialog-close" type="button" @click="dismissDialog(null)">&times;</button>
                      </div>
                      <div class="ext-dialog-description" x-show="extensionDialog.description" x-text="extensionDialog.description"></div>
                      <form class="ext-dialog-form" @submit.prevent="submitInputDialog()">
                        <input
                          class="ext-dialog-input"
                          type="text"
                          x-model="extensionDialog.inputValue"
                          :placeholder="extensionDialog.placeholder"
                          autofocus
                        />
                        <div class="ext-dialog-actions">
                          <button class="btn btn-ghost" type="button" @click="dismissDialog(null)">Cancel</button>
                          <button class="btn" type="submit">Submit</button>
                        </div>
                      </form>
                    </div>
                  </template>

                  <!-- Editor Dialog -->
                  <template x-if="extensionDialog?.type === 'editor'">
                    <div class="ext-dialog ext-dialog-wide">
                      <div class="ext-dialog-header">
                        <div class="ext-dialog-title" x-text="extensionDialog.title"></div>
                        <button class="ext-dialog-close" type="button" @click="dismissDialog(null)">&times;</button>
                      </div>
                      <div class="ext-dialog-description" x-show="extensionDialog.description" x-text="extensionDialog.description"></div>
                      <form class="ext-dialog-form" @submit.prevent="submitEditorDialog()">
                        <textarea
                          class="ext-dialog-editor"
                          x-model="extensionDialog.editorContent"
                          rows="12"
                          autofocus
                        ></textarea>
                        <div class="ext-dialog-actions">
                          <button class="btn btn-ghost" type="button" @click="dismissDialog(null)">Cancel</button>
                          <button class="btn" type="submit">Save</button>
                        </div>
                      </form>
                    </div>
                  </template>
                </div>

                <!-- Toast Notifications -->
                <div class="toast-container" x-show="toasts.length > 0" x-cloak>
                  <template x-for="toast in toasts" :key="toast.id">
                    <div class="toast" :class="`toast-${toast.level}`">
                      <span class="toast-icon" x-text="toast.style.icon"></span>
                      <span class="toast-message" x-text="toast.message"></span>
                      <button class="toast-close" type="button" @click="removeToast(toast.id)">&times;</button>
                    </div>
                  </template>
                </div>
              </section>
            </div>
          </div>
        </section>

        <section class="view config-view" x-show="view === 'config'" x-cloak role="tabpanel">
          <div class="view-header">// config</div>
          <div class="view-title">init.toml</div>
          <div class="view-body" x-data="rhoConfig()" x-init="init()">
            <div class="config-layout">
              <div class="config-header">
                <div>
                  <div class="config-filename">init.toml</div>
                  <div class="config-path" x-text="filePath"></div>
                </div>
                <div class="config-actions">
                  <div class="config-status" :class="{ saved: saveStatus === 'saved', error: saveStatus === 'error' }" x-text="statusMessage()"></div>
                  <button
                    class="btn"
                    type="button"
                    @click="save()"
                    :disabled="!dirty || isSaving"
                  >
                    Save
                  </button>
                </div>
              </div>
              <div class="config-error" x-show="error" x-text="error"></div>
              <textarea
                class="config-textarea"
                x-model="content"
                @input="handleInput()"
                placeholder="Loading..."
              ></textarea>
            </div>
          </div>
        </section>

        <section class="view memory-view" x-show="view === 'memory'" x-cloak role="tabpanel">
          <div class="view-header">// brain</div>
          <div class="view-title">Agent brain</div>
          <div class="view-body" x-data="rhoMemory()" x-init="init()">
            <div class="memory-stats">
              <span class="memory-stat">
                <span class="memory-stat-value" x-text="stats.total">0</span>
                <span class="memory-stat-label">total</span>
              </span>
              <span class="memory-stat">
                <span class="memory-stat-value learning" x-text="stats.learnings">0</span>
                <span class="memory-stat-label">learnings</span>
              </span>
              <span class="memory-stat">
                <span class="memory-stat-value preference" x-text="stats.preferences">0</span>
                <span class="memory-stat-label">preferences</span>
              </span>
              <span class="memory-stat">
                <span class="memory-stat-value behavior" x-text="stats.behaviors">0</span>
                <span class="memory-stat-label">behaviors</span>
              </span>
              <span class="memory-stat">
                <span class="memory-stat-value task" x-text="stats.tasks">0</span>
                <span class="memory-stat-label">tasks</span>
              </span>
              <span class="memory-stat">
                <span class="memory-stat-value reminder" x-text="stats.reminders">0</span>
                <span class="memory-stat-label">reminders</span>
              </span>
            </div>

            <div class="memory-controls">
              <div class="memory-filters">
                <button class="memory-filter-btn" :class="{ active: typeFilter === 'all' }" type="button" @click="setType('all')">All</button>
                <button class="memory-filter-btn" :class="{ active: typeFilter === 'behavior' }" type="button" @click="setType('behavior')">Behavior</button>
                <button class="memory-filter-btn" :class="{ active: typeFilter === 'identity' }" type="button" @click="setType('identity')">Identity</button>
                <button class="memory-filter-btn" :class="{ active: typeFilter === 'user' }" type="button" @click="setType('user')">User</button>
                <button class="memory-filter-btn" :class="{ active: typeFilter === 'learning' }" type="button" @click="setType('learning')">Learning</button>
                <button class="memory-filter-btn" :class="{ active: typeFilter === 'preference' }" type="button" @click="setType('preference')">Preference</button>
                <button class="memory-filter-btn" :class="{ active: typeFilter === 'context' }" type="button" @click="setType('context')">Context</button>
                <button class="memory-filter-btn" :class="{ active: typeFilter === 'task' }" type="button" @click="setType('task')">Task</button>
                <button class="memory-filter-btn" :class="{ active: typeFilter === 'reminder' }" type="button" @click="setType('reminder')">Reminder</button>
              </div>
              <div class="memory-filters-right">
                <button class="memory-add-btn" type="button" @click="toggleAddForm()">
                  <span x-text="showAddForm ? '‚úï Cancel' : '+ Add entry'"></span>
                </button>
                <select class="memory-category-select" x-model="categoryFilter" @change="load()">
                  <option value="">all categories</option>
                  <template x-for="cat in stats.categories" :key="cat">
                    <option :value="cat" x-text="cat"></option>
                  </template>
                </select>
                <select class="memory-sort-select" x-model="sortBy" @change="changeSort()">
                  <option value="created">newest</option>
                  <option value="last_used">last used</option>
                  <option value="used">most used</option>
                  <option value="alpha">a-z</option>
                </select>
              </div>
            </div>

            <!-- Add entry form -->
            <div class="memory-add-form" x-show="showAddForm" x-cloak>
              <div class="memory-add-form-row">
                <select class="memory-add-type-select" x-model="newEntryType">
                  <option value="learning">Learning</option>
                  <option value="preference">Preference</option>
                  <option value="behavior">Behavior</option>
                </select>
                <input
                  class="memory-add-category-input"
                  type="text"
                  placeholder="category"
                  x-model="newEntryCategory"
                  x-show="newEntryType === 'preference'"
                />
              </div>
              <textarea
                class="memory-add-textarea"
                placeholder="Entry text... (for behavior: prefix with do: / don't: / value:)"
                x-model="newEntryText"
                rows="2"
              ></textarea>
              <div class="memory-add-form-actions">
                <button class="btn btn-sm" type="button" @click="addEntry()" :disabled="!newEntryText.trim()">Save</button>
                <button class="btn btn-sm btn-ghost" type="button" @click="toggleAddForm()">Cancel</button>
              </div>
            </div>

            <div class="memory-search-wrap">
              <input
                class="memory-search"
                type="text"
                placeholder="search brain..."
                x-model="searchQuery"
                @input.debounce.300ms="load()"
              />
              <span class="memory-result-count" x-show="!isLoading" x-text="displayEntries.length + ' entries'"></span>
            </div>

            <div class="memory-error" x-show="error" x-text="error"></div>

            <div class="memory-loading" x-show="isLoading">
              <span class="loading-spinner"></span>
              <span>Loading brain...</span>
            </div>

            <form class="memory-task-form" x-show="typeFilter === 'task'" @submit.prevent="addTask()">
              <input type="text" x-model="newTaskDescription" placeholder="Task description..." class="memory-task-input" />
              <select x-model="newTaskPriority" class="memory-task-priority">
                <option value="urgent">Urgent</option>
                <option value="high">High</option>
                <option value="normal">Normal</option>
                <option value="low">Low</option>
              </select>
              <button class="btn btn-sm" type="submit" :disabled="!newTaskDescription.trim()">Add</button>
            </form>

            <div class="memory-list" x-show="!isLoading && entries.length > 0">
              <template x-for="entry in displayEntries" :key="entry.id">
                <div class="memory-card" :class="[entry.type, isStale(entry) ? 'stale' : '', entry.status === 'done' ? 'done' : '', editingId === entry.id ? 'editing' : '']">
                  <div class="memory-card-header">
                    <div class="memory-card-badges">
                      <label class="task-checkbox" x-show="entry.type === 'task'" @click.stop>
                        <input type="checkbox" :checked="entry.status === 'done'" @change="toggleTask(entry)" />
                      </label>
                      <span class="memory-type-badge" :class="entry.type" x-text="entry.type"></span>
                      <span class="memory-category-badge" x-show="entry.category && editingId !== entry.id" x-text="entry.category"></span>
                      <span class="memory-category-badge" x-show="entry.key && editingId !== entry.id" x-text="entry.key"></span>
                      <span class="memory-category-badge" x-show="entry.status && editingId !== entry.id" x-text="entry.status"></span>
                      <span class="memory-category-badge" x-show="entry.enabled !== undefined && editingId !== entry.id" x-text="entry.enabled ? 'on' : 'off'"></span>
                      <input
                        class="memory-edit-category-input"
                        type="text"
                        x-model="editCategory"
                        placeholder="category"
                        x-show="editingId === entry.id && entry.type === 'preference'"
                      />
                    </div>
                    <div class="memory-card-meta-right">
                      <span class="memory-card-date" x-show="entry.due">due <span x-text="entry.due"></span></span>
                      <span class="memory-card-date" x-text="entry.created || '--'"></span>
                      <button class="memory-edit-btn" type="button" @click="startEdit(entry)" title="Edit entry" x-show="editingId !== entry.id">‚úè</button>
                      <button class="memory-delete-btn" type="button" @click="entry.type === 'task' ? removeTask(entry) : remove(entry)" title="Delete entry" x-show="editingId !== entry.id">&times;</button>
                    </div>
                  </div>
                  <!-- Normal view -->
                  <div class="memory-card-text" x-show="editingId !== entry.id" x-text="entry._displayText || cardText(entry)"></div>
                  <!-- Edit view -->
                  <div x-show="editingId === entry.id">
                    <textarea
                      class="memory-edit-textarea"
                      x-model="editText"
                      rows="3"
                      @keydown.escape="cancelEdit()"
                    ></textarea>
                    <div class="memory-edit-actions">
                      <button class="btn btn-sm" type="button" @click="saveEdit(entry)" :disabled="!editText.trim()">Save</button>
                      <button class="btn btn-sm btn-ghost" type="button" @click="cancelEdit()">Cancel</button>
                    </div>
                  </div>
                  <div class="memory-card-footer" x-show="editingId !== entry.id">
                    <span class="memory-card-usage" x-show="entry.used > 0">
                      used <span x-text="entry.used"></span>x
                    </span>
                    <span class="memory-card-last-used" x-show="entry.last_used">
                      last: <span x-text="entry.last_used"></span>
                    </span>
                    <span class="memory-card-enabled" x-show="entry.type === 'reminder'">
                      <span x-text="entry.enabled ? '‚óè active' : '‚óã disabled'"></span>
                    </span>
                    <span class="memory-card-cadence" x-show="entry.cadence" x-text="entry.cadence?.kind === 'interval' ? 'every ' + entry.cadence.every : 'daily @ ' + entry.cadence?.at"></span>
                    <span class="memory-card-id" x-text="entry.id"></span>
                  </div>
                </div>
              </template>
              <div class="memory-empty" x-show="entries.length === 0 && !isLoading">
                <span class="empty-icon">&#x1F9E0;</span>
                <span>No matching entries</span>
              </div>
            </div>
            <div class="memory-empty" x-show="!isLoading && entries.length === 0 && !error">
              <span class="empty-icon">&#x1F9E0;</span>
              <span>No matching entries</span>
            </div>
          </div>
        </section>


        <section class="view review-view" x-show="view === 'review'" x-cloak role="tabpanel">
          <div class="view-header">// review</div>
          <div class="view-title">Git changes</div>
          <div class="view-body" x-data="rhoReviewDashboard()" x-init="init()">
            <div class="reviewdash">
              <template x-if="loading && !gitStatus">
                <div class="reviewdash-empty"><p class="text-muted">loading‚Ä¶</p></div>
              </template>

              <template x-if="!loading && error && !gitStatus">
                <div class="reviewdash-empty">
                  <p x-text="error"></p>
                  <p class="text-muted">check that you're in a git repository</p>
                </div>
              </template>

              <template x-if="!loading && !error && !gitStatus">
                <div class="reviewdash-empty">
                  <p>no git context detected</p>
                  <p class="text-muted">run a git command to get started</p>
                </div>
              </template>

              <template x-if="gitStatus">
                <div class="reviewdash-main">
                  <div class="reviewdash-scroll">
                    <div class="reviewdash-branch">
                      <span class="reviewdash-branch-icon">‚éá</span>
                      <span class="reviewdash-branch-name" x-text="gitStatus.branch"></span>
                      <span class="reviewdash-sep">¬∑</span>
                      <span class="reviewdash-summary" x-text="fileSummary()"></span>
                    </div>

                    <template x-if="gitStatus.sessionFiles.length > 0">
                      <div class="reviewdash-session-badge" x-text="gitStatus.sessionFiles.length + ' file' + (gitStatus.sessionFiles.length !== 1 ? 's' : '') + ' changed this session'"></div>
                    </template>

                    <template x-if="reviews.length > 0">
                      <div class="reviewdash-section">
                        <div class="reviewdash-section-title">active reviews</div>
                        <template x-for="r in reviews" :key="r.id">
                          <a class="reviewdash-review-row" :href="'/review/' + r.id + '?token=' + encodeURIComponent(r.token)">
                            <span class="reviewdash-dot"></span>
                            <span class="reviewdash-review-files" x-text="r.files.join(', ')"></span>
                            <span class="text-muted" x-text="relativeTime(r.createdAt)"></span>
                          </a>
                        </template>
                      </div>
                    </template>

                    <template x-if="gitStatus.files.length > 0">
                      <div class="reviewdash-files">
                        <template x-for="file in gitStatus.files" :key="file.path">
                          <div class="reviewdash-entry">
                            <div class="reviewdash-row" @click="toggleExpand(file.path)">
                              <label class="reviewdash-check" @click.stop>
                                <input type="checkbox" :checked="selected.includes(file.path)" @change="toggleSelect(file.path)">
                              </label>
                              <span class="reviewdash-status" :class="file.status" x-text="file.statusLabel"></span>
                              <span class="reviewdash-path" x-text="file.path"></span>
                              <template x-if="file.isSession">
                                <span class="reviewdash-session-dot" title="Changed this session">‚óè</span>
                              </template>
                              <span class="reviewdash-stats" x-show="file.additions || file.deletions">
                                <span class="reviewdash-add" x-show="file.additions" x-text="'+' + file.additions"></span>
                                <span class="reviewdash-del" x-show="file.deletions" x-text="'‚àí' + file.deletions"></span>
                              </span>
                              <span class="reviewdash-chevron" x-text="expanded.includes(file.path) ? '‚ñæ' : '‚ñ∏'"></span>
                            </div>

                            <div class="reviewdash-diff-wrap" x-show="expanded.includes(file.path)">
                              <template x-if="diffs[file.path] === false">
                                <div class="reviewdash-diff-loading">loading diff‚Ä¶</div>
                              </template>
                              <template x-if="diffs[file.path] === ''">
                                <div class="reviewdash-diff-empty">no diff available</div>
                              </template>
                              <template x-if="diffs[file.path] && diffs[file.path] !== false">
                                <div x-html="renderDiff(diffs[file.path])"></div>
                              </template>
                            </div>
                          </div>
                        </template>
                      </div>
                    </template>

                    <template x-if="gitStatus.files.length === 0">
                      <div class="reviewdash-empty">
                        <p class="text-muted">working tree clean</p>
                      </div>
                    </template>

                    <template x-if="gitStatus.log.length > 0">
                      <div class="reviewdash-commits">
                        <div class="reviewdash-section-title">recent commits</div>
                        <template x-for="entry in gitStatus.log" :key="entry.hash">
                          <div class="reviewdash-commit-row">
                            <span class="reviewdash-commit-hash" x-text="entry.hash"></span>
                            <span class="reviewdash-commit-msg" x-text="entry.message"></span>
                          </div>
                        </template>
                      </div>
                    </template>
                  </div>

                  <div class="reviewdash-actions" x-show="selected.length > 0">
                    <span class="reviewdash-actions-count" x-text="selected.length + ' file' + (selected.length !== 1 ? 's' : '')"></span>
                    <div class="reviewdash-actions-row">
                      <button class="reviewdash-btn" @click="selectAll()">
                        <span x-text="selected.length === (gitStatus?.files?.filter(f => f.status !== 'deleted').length ?? 0) ? 'None' : 'All'"></span>
                      </button>
                      <button class="reviewdash-btn primary" @click="startReview()">Review ‚Üí</button>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </section>

      </main>

      <footer class="footer">
        <div class="footer-inner">
          <span class="footer-model">model: --</span>
          <span class="footer-tokens">tokens: --</span>
          <span class="footer-cost">cost: --</span>
          <span class="footer-status">status: idle</span>
          <span class="footer-ext-status"></span>
        </div>
      </footer>
    </div>
    <script>
      // Register service worker for PWA
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js').catch((err) => {
            console.log('SW registration failed:', err);
          });
        });
      }
    </script>
  </body>
</html>
